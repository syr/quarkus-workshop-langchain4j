
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../step-08/">
      
      
        <link rel="next" href="../step-10/">
      
      
      <link rel="icon" href="../images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.34">
    
    
      
        <title>Step 9 - Observability and Fault Tolerance - Quarkus LangChain4j Workshop</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.35f28582.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CUbuntu+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Ubuntu Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#step-09-observability-and-fault-tolerance" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
You are not viewing the latest version.
<a href="../..">
    <strong>Click here to go to latest.</strong>
</a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Quarkus LangChain4j Workshop" class="md-header__button md-logo" aria-label="Quarkus LangChain4j Workshop" data-md-component="logo">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Quarkus LangChain4j Workshop
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Step 9 - Observability and Fault Tolerance
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H6zm7-4.68V17c0 .55-.45 1-1 1H6c-.55 0-1-.45-1-1v-2.26C3.19 13.47 2 11.38 2 9c0-3.87 3.13-7 7-7 1.65 0 3.16.57 4.35 1.5C10.8 4.57 9 7.07 9 10c0 2.79 1.64 5.19 4 6.32m7.92-6.38-1.42-.91-1.4.97.4-1.65-1.33-1.03 1.68-.11.56-1.61.63 1.58 1.68.04-1.3 1.08zM19.39 13c-1.89 2.27-5.36 2.19-7.17-.05C10 10.13 11.56 6 15 5.34c.34-.05.64.29.5.63-.45 1.28-.38 2.74.35 4a4.62 4.62 0 0 0 3.27 2.28c.35.05.5.49.27.75"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 6a6 6 0 0 1 6 6c0 2.22-1.21 4.16-3 5.2V19a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-1.8c-1.79-1.04-3-2.98-3-5.2a6 6 0 0 1 6-6m2 15v1a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-1zm6-10h3v2h-3zM1 11h3v2H1zM13 1v3h-2V1zM4.92 3.5l2.13 2.14-1.42 1.41L3.5 4.93zm12.03 2.13 2.12-2.13 1.43 1.43-2.13 2.12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/quarkusio/quarkus-langchain4j-workshop" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Quarkus LangChain4j Workshop" class="md-nav__button md-logo" aria-label="Quarkus LangChain4j Workshop" data-md-component="logo">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    Quarkus LangChain4j Workshop
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/quarkusio/quarkus-langchain4j-workshop" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../requirements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Requirements
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-01/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 1 - Introduction to Quarkus LangChain4j
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-02/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 2 - Playing with model parameters
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-03/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 3 - Streaming responses
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-04/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 4 - Using system messages
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-05/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 5 - Introduction to the RAG pattern
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-06/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 6 - Deconstructing the RAG
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-07/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 7 - Function calling and tools
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-08/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 8 - Guardrails
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Step 9 - Observability and Fault Tolerance
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Step 9 - Observability and Fault Tolerance
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#observability" class="md-nav__link">
    <span class="md-ellipsis">
      Observability
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Observability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      Logging
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    <span class="md-ellipsis">
      Metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracing" class="md-nav__link">
    <span class="md-ellipsis">
      Tracing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tools-to-visualize-your-collected-observability-data-on-your-local-machine" class="md-nav__link">
    <span class="md-ellipsis">
      Tools to visualize your collected observability data on your local machine
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tools to visualize your collected observability data on your local machine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quarkus-dev-ui" class="md-nav__link">
    <span class="md-ellipsis">
      Quarkus Dev UI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quarkus-otel-lgtm-dev-service" class="md-nav__link">
    <span class="md-ellipsis">
      Quarkus Otel LGTM Dev Service
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fault-tolerance" class="md-nav__link">
    <span class="md-ellipsis">
      Fault Tolerance
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-10/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Step 10 - Serving the model in pure Java with Jlama
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../conclusion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Conclusion
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#observability" class="md-nav__link">
    <span class="md-ellipsis">
      Observability
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Observability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      Logging
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    <span class="md-ellipsis">
      Metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracing" class="md-nav__link">
    <span class="md-ellipsis">
      Tracing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tools-to-visualize-your-collected-observability-data-on-your-local-machine" class="md-nav__link">
    <span class="md-ellipsis">
      Tools to visualize your collected observability data on your local machine
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tools to visualize your collected observability data on your local machine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quarkus-dev-ui" class="md-nav__link">
    <span class="md-ellipsis">
      Quarkus Dev UI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quarkus-otel-lgtm-dev-service" class="md-nav__link">
    <span class="md-ellipsis">
      Quarkus Otel LGTM Dev Service
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fault-tolerance" class="md-nav__link">
    <span class="md-ellipsis">
      Fault Tolerance
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<div><h1 id="step-09-observability-and-fault-tolerance">Step 09 - Observability and Fault Tolerance<a class="headerlink" href="#step-09-observability-and-fault-tolerance" title="Permanent link"></a></h1>
<p>In the previous step we introduced guardrailing, allowing us to mitigate prompt injection using guardrails.
While it’s certainly important to protect against prompt injection, it’s also important to ensure that if
something goes wrong, we can quickly identify issues, and handle failures gracefully as well. </p>
<p>For this,
we will add observability to our LLM interactions by implementing logging, tracing, and metrics to our application.
In addition, we will add fault tolerance to our LLM interactions by implementing retries and fallback mechanisms.</p>
<!--![Observability](images/observability.png)-->

<h2 id="observability">Observability<a class="headerlink" href="#observability" title="Permanent link"></a></h2>
<p>The 3 main pillars of observability are logging, tracing, and metrics.
In the following sections, we will explore how to implement observability to gain valuable insights into our
application’s behavior, in particular with regards to its interactions with LLMs. Implemeting these features with
Quarkus is a straightforward process and can be easily integrated into your existing Quarkus applications.</p>
<p>The final code of this step is available in the <code>step-09</code> directory.</p>
<h3 id="logging">Logging<a class="headerlink" href="#logging" title="Permanent link"></a></h3>
<p>To ensure that our LLM interactions are monitored and logged, we need to implement logging in our application.
This will allow us to track the input and output of each interaction with the model,
as well as any errors or exceptions that occur. As you might have noticed throughout this lab, you have in fact
already been logging interactions with the model in previous steps.</p>
<p>Go ahead and examine the application.properties file in the <code>src/main/resources</code> directory.
You will see 2 properties (if you don’t see them, go ahead and add them):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="na">quarkus.langchain4j.openai.chat-model.log-requests</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="na">quarkus.langchain4j.openai.chat-model.log-responses</span><span class="o">=</span><span class="s">true</span>
</code></pre></div>
<p>The <code>log-requests</code> property enables logging of all requests made to the model,
while the <code>log-responses</code> property enables logging of all responses received from the model.
These logs provide valuable insights into how the LLM is interacting with your application and any issues that arise.
Go ahead and start up Quarkus Dev Mode if you haven’t already with <code>./mvnw quarkus:dev</code> go to http://localhost:8080
and open the chat interface in the bottom right of your screen. Send an instruction to the bot and then come
back to your console. You’ll see a series requests/responses to/from the LLM with a bunch of information such as
the url, headers, and in the body, the model you called, the messages, temperature, tokens and more.</p>
<div class="highlight"><span class="filename">Example Log Output</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="m">09</span>:50:54<span class="w"> </span>INFO<span class="w">  </span><span class="nv">traceId</span><span class="o">=</span>cb938581635e7777244c57bc4ece04db,<span class="w"> </span><span class="nv">parentId</span><span class="o">=</span>d7888051b1772651,<span class="w"> </span><span class="nv">spanId</span><span class="o">=</span>f92dfd63091f4efa,<span class="w"> </span><span class="nv">sampled</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="o">[</span>io.qu.la.op.co.OpenAiRestApi<span class="nv">$OpenAiClientLogger</span><span class="o">]</span><span class="w"> </span><span class="o">(</span>vert.x-eventloop-thread-5<span class="o">)</span><span class="w"> </span>Request:
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>-<span class="w"> </span>method:<span class="w"> </span>POST
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>-<span class="w"> </span>url:<span class="w"> </span>https://api.openai.com/v1/chat/completions
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>-<span class="w"> </span>headers:<span class="w"> </span><span class="o">[</span>Accept:<span class="w"> </span>application/json<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>Authorization:<span class="w"> </span>Be...1B<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>Content-Type:<span class="w"> </span>application/json<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>User-Agent:<span class="w"> </span>langchain4j-openai<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>content-length:<span class="w"> </span><span class="m">2335</span><span class="o">]</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>-<span class="w"> </span>body:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">  </span><span class="s2">"model"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"gpt-4o"</span>,
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">  </span><span class="s2">"messages"</span><span class="w"> </span>:<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="s2">"role"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"system"</span>,
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="s2">"content"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"You are a customer support agent of a car rental company 'Miles of Smiles'.\nYou are friendly, polite and concise.\nIf the question is unrelated to car rental, you should politely redirect the customer to the right department.\n\nToday is 2025-01-10.\n"</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">  </span><span class="o">}</span>,<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="s2">"role"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"user"</span>,
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="s2">"content"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"what services are available?\nPlease, only use the following information:\n- United States of America.\n2. The Services\n- from within any country in the world, of applications, websites, content, products, and services\n- liable for any modification, suspension or discontinuation of the Services.\n"</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">  </span><span class="o">}</span><span class="w"> </span><span class="o">]</span>,
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">  </span><span class="s2">"temperature"</span><span class="w"> </span>:<span class="w"> </span><span class="m">1</span>.0,
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">  </span><span class="s2">"top_p"</span><span class="w"> </span>:<span class="w"> </span><span class="m">1</span>.0,
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">  </span><span class="s2">"max_tokens"</span><span class="w"> </span>:<span class="w"> </span><span class="m">1000</span>,
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">  </span><span class="s2">"presence_penalty"</span><span class="w"> </span>:<span class="w"> </span><span class="m">0</span>.0,
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">  </span><span class="s2">"frequency_penalty"</span><span class="w"> </span>:<span class="w"> </span><span class="m">0</span>.0,
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">  </span><span class="s2">"tools"</span><span class="w"> </span>:<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">    </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"function"</span>,
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w">    </span><span class="s2">"function"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">      </span><span class="s2">"name"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"cancelBooking"</span>,
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="w">      </span><span class="s2">"description"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"Cancel a booking"</span>,
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="w">      </span><span class="s2">"parameters"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="w">        </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"object"</span>,
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="w">        </span><span class="s2">"properties"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="w">          </span><span class="s2">"bookingId"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="w">            </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"integer"</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="w">          </span><span class="o">}</span>,
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="w">          </span><span class="s2">"customerFirstName"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="w">            </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"string"</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="w">          </span><span class="o">}</span>,
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a><span class="w">          </span><span class="s2">"customerLastName"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a><span class="w">            </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"string"</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a><span class="w">          </span><span class="o">}</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a><span class="w">        </span><span class="o">}</span>,
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="w">        </span><span class="s2">"required"</span><span class="w"> </span>:<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"bookingId"</span>,<span class="w"> </span><span class="s2">"customerFirstName"</span>,<span class="w"> </span><span class="s2">"customerLastName"</span><span class="w"> </span><span class="o">]</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a><span class="w">      </span><span class="o">}</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="w">    </span><span class="o">}</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a><span class="w">  </span><span class="o">}</span>,<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="w">    </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"function"</span>,
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a><span class="w">    </span><span class="s2">"function"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a><span class="w">      </span><span class="s2">"name"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"listBookingsForCustomer"</span>,
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a><span class="w">      </span><span class="s2">"description"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"List booking for a customer"</span>,
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a><span class="w">      </span><span class="s2">"parameters"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a><span class="w">        </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"object"</span>,
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a><span class="w">        </span><span class="s2">"properties"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a><span class="w">          </span><span class="s2">"customerName"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a><span class="w">            </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"string"</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a><span class="w">          </span><span class="o">}</span>,
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a><span class="w">          </span><span class="s2">"customerSurname"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a><span class="w">            </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"string"</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a><span class="w">          </span><span class="o">}</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a><span class="w">        </span><span class="o">}</span>,
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a><span class="w">        </span><span class="s2">"required"</span><span class="w"> </span>:<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"customerName"</span>,<span class="w"> </span><span class="s2">"customerSurname"</span><span class="w"> </span><span class="o">]</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a><span class="w">      </span><span class="o">}</span>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a><span class="w">    </span><span class="o">}</span>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a><span class="w">  </span><span class="o">}</span>,<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a><span class="w">    </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"function"</span>,
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a><span class="w">    </span><span class="s2">"function"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a><span class="w">      </span><span class="s2">"name"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"getBookingDetails"</span>,
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a><span class="w">      </span><span class="s2">"description"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"Get booking details"</span>,
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a><span class="w">      </span><span class="s2">"parameters"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a><span class="w">        </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"object"</span>,
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a><span class="w">        </span><span class="s2">"properties"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a><span class="w">          </span><span class="s2">"bookingId"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a><span class="w">            </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"integer"</span>
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a><span class="w">          </span><span class="o">}</span>,
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a><span class="w">          </span><span class="s2">"customerFirstName"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a><span class="w">            </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"string"</span>
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a><span class="w">          </span><span class="o">}</span>,
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a><span class="w">          </span><span class="s2">"customerLastName"</span><span class="w"> </span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a><span class="w">            </span><span class="s2">"type"</span><span class="w"> </span>:<span class="w"> </span><span class="s2">"string"</span>
<a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a><span class="w">          </span><span class="o">}</span>
<a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a><span class="w">        </span><span class="o">}</span>,
<a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a><span class="w">        </span><span class="s2">"required"</span><span class="w"> </span>:<span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"bookingId"</span>,<span class="w"> </span><span class="s2">"customerFirstName"</span>,<span class="w"> </span><span class="s2">"customerLastName"</span><span class="w"> </span><span class="o">]</span>
<a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a><span class="w">      </span><span class="o">}</span>
<a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a><span class="w">    </span><span class="o">}</span>
<a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a><span class="w">  </span><span class="o">}</span><span class="w"> </span><span class="o">]</span>
<a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a><span class="o">}</span>
<a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a>
<a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a><span class="w">  </span><span class="m">09</span>:50:55<span class="w"> </span>INFO<span class="w">  </span><span class="nv">traceId</span><span class="o">=</span>cb938581635e7777244c57bc4ece04db,<span class="w"> </span><span class="nv">parentId</span><span class="o">=</span>d7888051b1772651,<span class="w"> </span><span class="nv">spanId</span><span class="o">=</span>f92dfd63091f4efa,<span class="w"> </span><span class="nv">sampled</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="o">[</span>io.qu.la.op.co.OpenAiRestApi<span class="nv">$OpenAiClientLogger</span><span class="o">]</span><span class="w"> </span><span class="o">(</span>vert.x-eventloop-thread-5<span class="o">)</span><span class="w"> </span>Response:
<a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a>-<span class="w"> </span>status<span class="w"> </span>code:<span class="w"> </span><span class="m">200</span>
<a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a>-<span class="w"> </span>headers:<span class="w"> </span><span class="o">[</span>Date:<span class="w"> </span>Fri,<span class="w"> </span><span class="m">10</span><span class="w"> </span>Jan<span class="w"> </span><span class="m">2025</span><span class="w"> </span><span class="m">08</span>:50:55<span class="w"> </span>GMT<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>Content-Type:<span class="w"> </span>application/json<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>Transfer-Encoding:<span class="w"> </span>chunked<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>Connection:<span class="w"> </span>keep-alive<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>access-control-expose-headers:<span class="w"> </span>X-Request-ID<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>openai-organization:<span class="w"> </span>user-qsgtnhp4stba6axsc0rzfyum<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>openai-processing-ms:<span class="w"> </span><span class="m">1531</span><span class="o">]</span>,<span class="w"> </span><span class="o">[</span>openai-version:<span class="w"> </span><span class="m">2020</span>-10-01<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>x-ratelimit-limit-requests:<span class="w"> </span><span class="m">500</span><span class="o">]</span>,<span class="w"> </span><span class="o">[</span>x-ratelimit-limit-tokens:<span class="w"> </span><span class="m">30000</span><span class="o">]</span>,<span class="w"> </span><span class="o">[</span>x-ratelimit-remaining-requests:<span class="w"> </span><span class="m">499</span><span class="o">]</span>,<span class="w"> </span><span class="o">[</span>x-ratelimit-remaining-tokens:<span class="w"> </span><span class="m">28713</span><span class="o">]</span>,<span class="w"> </span><span class="o">[</span>x-ratelimit-reset-requests:<span class="w"> </span>120ms<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>x-ratelimit-reset-tokens:<span class="w"> </span><span class="m">2</span>.572s<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>x-request-id:<span class="w"> </span>req_33432b46a09d2e3e4918cdc085747825<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>strict-transport-security:<span class="w"> </span>max-age<span class="o">=</span><span class="m">31536000</span><span class="p">;</span><span class="w"> </span>includeSubDomains<span class="p">;</span><span class="w"> </span>preload<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>CF-Cache-Status:<span class="w"> </span>DYNAMIC<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>Set-Cookie:<span class="w"> </span>__...ne<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>X-Content-Type-Options:<span class="w"> </span>nosniff<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>Set-Cookie:<span class="w"> </span>_c...ne<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>Server:<span class="w"> </span>cloudflare<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>CF-RAY:<span class="w"> </span>8ffb6c11687983dd-BRU<span class="o">]</span>,<span class="w"> </span><span class="o">[</span>alt-svc:<span class="w"> </span><span class="nv">h3</span><span class="o">=</span><span class="s2">":443"</span><span class="p">;</span><span class="w"> </span><span class="nv">ma</span><span class="o">=</span><span class="m">86400</span><span class="o">]</span>
<a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a>-<span class="w"> </span>body:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a><span class="w">  </span><span class="s2">"id"</span>:<span class="w"> </span><span class="s2">"chatcmpl-Ao51CDrgIYFN25RIK4GJAdvQjp5tY"</span>,
<a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a><span class="w">  </span><span class="s2">"object"</span>:<span class="w"> </span><span class="s2">"chat.completion"</span>,
<a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a><span class="w">  </span><span class="s2">"created"</span>:<span class="w"> </span><span class="m">1736499054</span>,
<a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a><span class="w">  </span><span class="s2">"model"</span>:<span class="w"> </span><span class="s2">"gpt-4o-2024-08-06"</span>,
<a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a><span class="w">  </span><span class="s2">"choices"</span>:<span class="w"> </span><span class="o">[</span>
<a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a><span class="w">    </span><span class="o">{</span>
<a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a><span class="w">      </span><span class="s2">"index"</span>:<span class="w"> </span><span class="m">0</span>,
<a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a><span class="w">      </span><span class="s2">"message"</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a><span class="w">        </span><span class="s2">"role"</span>:<span class="w"> </span><span class="s2">"assistant"</span>,
<a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a><span class="w">        </span><span class="s2">"content"</span>:<span class="w"> </span><span class="s2">"Our car rental services, under the name \"Miles of Smiles,\" are available for users within the United States. These services include a variety of applications, websites, content, products, and services related to car rental. Please feel free to ask any specific questions about our car rental options!"</span>,
<a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a><span class="w">        </span><span class="s2">"refusal"</span>:<span class="w"> </span>null
<a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a><span class="w">      </span><span class="o">}</span>,
<a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a><span class="w">      </span><span class="s2">"logprobs"</span>:<span class="w"> </span>null,
<a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a><span class="w">      </span><span class="s2">"finish_reason"</span>:<span class="w"> </span><span class="s2">"stop"</span>
<a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a><span class="w">    </span><span class="o">}</span>
<a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a><span class="w">  </span><span class="o">]</span>,
<a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a><span class="w">  </span><span class="s2">"usage"</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a><span class="w">    </span><span class="s2">"prompt_tokens"</span>:<span class="w"> </span><span class="m">228</span>,
<a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a><span class="w">    </span><span class="s2">"completion_tokens"</span>:<span class="w"> </span><span class="m">60</span>,
<a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a><span class="w">    </span><span class="s2">"total_tokens"</span>:<span class="w"> </span><span class="m">288</span>,
<a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a><span class="w">    </span><span class="s2">"prompt_tokens_details"</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a><span class="w">      </span><span class="s2">"cached_tokens"</span>:<span class="w"> </span><span class="m">0</span>,
<a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a><span class="w">      </span><span class="s2">"audio_tokens"</span>:<span class="w"> </span><span class="m">0</span>
<a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a><span class="w">    </span><span class="o">}</span>,
<a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a><span class="w">    </span><span class="s2">"completion_tokens_details"</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a><span class="w">      </span><span class="s2">"reasoning_tokens"</span>:<span class="w"> </span><span class="m">0</span>,
<a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a><span class="w">      </span><span class="s2">"audio_tokens"</span>:<span class="w"> </span><span class="m">0</span>,
<a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a><span class="w">      </span><span class="s2">"accepted_prediction_tokens"</span>:<span class="w"> </span><span class="m">0</span>,
<a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a><span class="w">      </span><span class="s2">"rejected_prediction_tokens"</span>:<span class="w"> </span><span class="m">0</span>
<a id="__codelineno-1-115" name="__codelineno-1-115" href="#__codelineno-1-115"></a><span class="w">    </span><span class="o">}</span>
<a id="__codelineno-1-116" name="__codelineno-1-116" href="#__codelineno-1-116"></a><span class="w">  </span><span class="o">}</span>,
<a id="__codelineno-1-117" name="__codelineno-1-117" href="#__codelineno-1-117"></a><span class="w">  </span><span class="s2">"service_tier"</span>:<span class="w"> </span><span class="s2">"default"</span>,
<a id="__codelineno-1-118" name="__codelineno-1-118" href="#__codelineno-1-118"></a><span class="w">  </span><span class="s2">"system_fingerprint"</span>:<span class="w"> </span><span class="s2">"fp_b7d65f1a5b"</span>
<a id="__codelineno-1-119" name="__codelineno-1-119" href="#__codelineno-1-119"></a><span class="o">}</span>
</code></pre></div>
<p>By default the logs are output the console. In a production system the console output is typically forwarded
to a log aggregation service so logs can be centralized and searched in more advanced ways.
We’ll take a look at a log collection system in a little bit, but first let’s take a look at how to collect
metrics from our application.</p>
<h3 id="metrics">Metrics<a class="headerlink" href="#metrics" title="Permanent link"></a></h3>
<p>It’s also important to gain insight into the performance and behavior of our application
through the use of metrics and cold hard numbers. Using these metrics,
we can create meaningful graphs, dashboards and alerts.</p>
<p>The (currently) preferred way to gather metrics in Quarkus is to use the micrometer project.
You can add metrics collection with micrometer by adding the <code>quarkus-micrometer</code> extension to the pom.xml.
You then need to add a collector specific extension to format the metrics accordingly. In the below example
we have included extensions for Prometheus and general purpose OpenTelemetry.</p>
<div class="highlight"><span class="filename">pom.xml</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>io.quarkus<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>quarkus-micrometer<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">        </span><span class="cm">&lt;!-- Automatically format metrics for Prometheus --&gt;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>io.quarkus<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>quarkus-micrometer-registry-prometheus<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">        </span><span class="cm">&lt;!-- Export metrics for OpenTelemetry compatible collectors --&gt;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>io.quarkiverse.micrometer.registry<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>quarkus-micrometer-registry-otlp<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">            </span><span class="nt">&lt;version&gt;</span>3.2.4<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>
<p>By Quarkus default will collect a variety of useful metrics for you by default,
eg., CPU &amp; memory usage, garbage collection stats, etc. The LangChain4j extension will add useful metrics
about the LLM interactions as well. Such as eg.:</p>
<div class="highlight"><span class="filename">Example of some of the LangChain4j metrics</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># HELP langchain4j_aiservices_seconds_max </span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="c1"># TYPE langchain4j_aiservices_seconds_max gauge</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>langchain4j_aiservices_seconds_max<span class="o">{</span><span class="nv">aiservice</span><span class="o">=</span><span class="s2">"CustomerSupportAgent"</span>,method<span class="o">=</span><span class="s2">"chat"</span>,<span class="o">}</span><span class="w"> </span><span class="m">0</span>.0
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>langchain4j_aiservices_seconds_max<span class="o">{</span><span class="nv">aiservice</span><span class="o">=</span><span class="s2">"PromptInjectionDetectionService"</span>,method<span class="o">=</span><span class="s2">"isInjection"</span>,<span class="o">}</span><span class="w"> </span><span class="m">0</span>.0
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="c1"># HELP langchain4j_aiservices_seconds </span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="c1"># TYPE langchain4j_aiservices_seconds summary</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>langchain4j_aiservices_seconds_count<span class="o">{</span><span class="nv">aiservice</span><span class="o">=</span><span class="s2">"CustomerSupportAgent"</span>,method<span class="o">=</span><span class="s2">"chat"</span>,<span class="o">}</span><span class="w"> </span><span class="m">1</span>.0
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>langchain4j_aiservices_seconds_sum<span class="o">{</span><span class="nv">aiservice</span><span class="o">=</span><span class="s2">"CustomerSupportAgent"</span>,method<span class="o">=</span><span class="s2">"chat"</span>,<span class="o">}</span><span class="w"> </span><span class="m">2</span>.485171837
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>langchain4j_aiservices_seconds_count<span class="o">{</span><span class="nv">aiservice</span><span class="o">=</span><span class="s2">"PromptInjectionDetectionService"</span>,method<span class="o">=</span><span class="s2">"isInjection"</span>,<span class="o">}</span><span class="w"> </span><span class="m">1</span>.0
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>langchain4j_aiservices_seconds_sum<span class="o">{</span><span class="nv">aiservice</span><span class="o">=</span><span class="s2">"PromptInjectionDetectionService"</span>,method<span class="o">=</span><span class="s2">"isInjection"</span>,<span class="o">}</span><span class="w"> </span><span class="m">0</span>.775163834
</code></pre></div>
<p>You can also customize the metrics collection by adding
your own custom metrics. You can find more information about how to use Quarkus Micrometer in the
<a href="https://quarkus.io/guides/micrometer">Quarkus Micrometer documentation</a>.</p>
<h3 id="tracing">Tracing<a class="headerlink" href="#tracing" title="Permanent link"></a></h3>
<p>Tracing is another important aspect of observability.
It involves tracking the flow of requests and responses through your application,
and identifying any anomalies or inconsistencies that may indicate a problem.
It also allows you to identify bottlenecks and areas for improvement in your application.
For example, you could track the amount of time it took to call the model,
and identify any requests that took longer than expected.
You can then tie these traces back to specific log entries or lines in your code.</p>
<p>Tracing can also help you detect anomalies in the behavior of your application over time, such as a sudden increase in traffic or a drop in response times.</p>
<p>Quarkus implements the OpenTelemetry project for tracing capabilities, allowing you to collect and analyze
 trace data from your LangChain4j application. You can use the OpenTelemetry API to send traces to a tracing service
such as Jaeger, Zipkin, or Tempo, which can then be used for monitoring and debugging purposes.</p>
<p>To add OpenTelemetry (and by extension tracing) to your application, you will need to add the opentelemetry
extensions to your pom.xml file. You can optionally also add the opentelemetry-jdbc dependency to collect
 trace data from JDBC queries.</p>
<div class="highlight"><span class="filename">pom.xml</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>io.quarkus<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>quarkus-opentelemetry<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>io.opentelemetry.instrumentation<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>opentelemetry-jdbc<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>
<p>By adding these extensions to your applications, Quarkus does a lot of heavy lifting for you in terms of setting up
and configuring the OpenTelemetry API, including sending traces to a tracing service. Quarkus LangChain4j automatically
integrates with the OpenTelemetry extension to collect traces regarding your interactions with LLMs as well.</p>
<p>You can configure the opentelemetry tracing functionality by eg. setting
the endpoint and headers for your tracing service, as well as the format of the traces:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># quarkus.otel.exporter.otlp.traces.endpoint=http://localhost:4317</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="na">quarkus.otel.exporter.otlp.traces.headers</span><span class="o">=</span><span class="s">authorization=Bearer my_secret </span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="na">quarkus.log.console.format</span><span class="o">=</span><span class="s">%d{HH:mm:ss} %-5p traceId=%X{traceId}, parentId=%X{parentId}, spanId=%X{spanId}, sampled=%X{sampled} [%c{2.}] (%t) %s%e%n  </span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="c1"># enable tracing db requests</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="na">quarkus.datasource.jdbc.telemetry</span><span class="o">=</span><span class="s">true</span>
</code></pre></div>
<p>You might notice in the above example that the traces endpoint is commented out.
If you have a tracing service running, you can set the endpoint accordingly.
In a production environment you will likely override this value with an environment variable or ConfigMap or something similar.
In our case however, we’re going to use a Quarkus Dev Service to capture and visualize the traces, as well as logs and metrics.</p>
<h3 id="tools-to-visualize-your-collected-observability-data-on-your-local-machine">Tools to visualize your collected observability data on your local machine<a class="headerlink" href="#tools-to-visualize-your-collected-observability-data-on-your-local-machine" title="Permanent link"></a></h3>
<p>In production, your organization will likely already have tools set up to collect observability data,
however Quarkus offers a few ways to visualize and search the collected data on your local machine.</p>
<h4 id="quarkus-dev-ui">Quarkus Dev UI<a class="headerlink" href="#quarkus-dev-ui" title="Permanent link"></a></h4>
<p>Let’s start with the Quarkus Dev UI. Go ahead and open it at http://localhost:8080/q/dev-ui.
If you’ve added the micrometer and micrometer-registry-prometheus extensions, you will see a “Micrometer metrics” card
in the extensions menu.</p>
<p><img alt="Micrometer card in Quarkus Dev UI" src="../images/micrometer-card.png"></p>
<p>Go ahead and click on the Prometheus (raw output), and search for “langchain4j”. Notice all the metrics collected by
the LangChain4j extension. Feel free to play around with the application and refresh the metrics to see how they’re affected.</p>
<h4 id="quarkus-otel-lgtm-dev-service">Quarkus Otel LGTM Dev Service<a class="headerlink" href="#quarkus-otel-lgtm-dev-service" title="Permanent link"></a></h4>
<p>Quarkus also provides an experimental new Dev Service to help visualize all your OpenTelemetry observability data in a central place.
It is based on the open source LGTM stack, which stands for Loki (log aggregation), Grafana (graph tool), Tempo (traces aggregation)
and Prometheus (metrics aggregation). By adding the <code>quarkus-observability-devservices-gtm</code> extension, this set of tools will
automatically (or may we say ‘automagically’?) start up in their respective containers and wire up to your application’s observability endpoints.</p>
<p>Add the following dependencies in your <code>pom.xml</code>:</p>
<div class="highlight"><span class="filename">pom.xml</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>io.quarkus<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>quarkus-observability-devservices-lgtm<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">            </span><span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>
<p>In the application.properties, let’s enable the OpenTelemetry tracing and log collection features:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="na">quarkus.otel.logs.enabled</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="na">quarkus.otel.traces.enabled</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="c1"># Disable LTGM in test mode</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="na">%test.quarkus.observability.enabled</span><span class="o">=</span><span class="s">false</span>
</code></pre></div>
<p>Now refresh the chatbot application in your browser and interact with the bot again to generate some new observability data.
Note that it could take a bit longer for the application to start up, since Quarkus is starting up the LGTM Dev Services containers
in the background.</p>
<p>After you’ve generated some data, let’s go and explore this data in Grafana. The Dev Service exposes a random port.
The easiest way to find it is to go to the Quarkus Dev UI (http://localhost:8080/q/dev-ui) and click on the “Dev Services” menu item.</p>
<p><img alt="Quarkus Dev Services" src="../images/dev-services-observability.png"></p>
<p>Find the <code>grafana.endpoint</code> and open the url in another browser tab. Use admin/admin to log in if you need to.</p>
<p>Let’s first explore the provided custom metrics dashboards that the dev service creates. Go to “Dashboards” in the left menu.
You will notice 2 dashboards, one for OTLP and one for Prometheus. Remember how we added both the Micrometer OpenTelemetry and Prometheus
registry extensions? They’re both reflected here. Feel free to explore the dashboards.
If you don’t see much data data in the graphs, you may want to select a shorter time span in the top right of your screen and/or
create some more chat requests.</p>
<p><img alt="Grafana Dashboard" src="../images/grafana-dashboard.png"></p>
<p>You can also find an aggregation of all metrics (including the langchain4j relevant ones) by going to Explore &gt; Metrics:</p>
<p><img alt="Prometheus Metrics graphs" src="../images/prometheus-metrics.png"></p>
<p>Now let’s explore the Query functionality to find specific data. Click on the <code>Explore</code> menu item.
An interactive query window will open up.
Next to “Outline” you’ll see that Prometheus is selected in the dropdown. Select <code>gen_ai_client_estimated_cost_total</code>.
Then, in label filters, select <code>currency</code> and value <code>USD</code>. Finally, click the Run query button to see the results.
You should see an estimated cost aggregation of the latest calls to the model. This is an experimental feature
based on what typical calls to ChatGPT cost.</p>
<p><img alt="Estimated Cost Graph" src="../images/genai-estimated-cost.png"></p>
<p>Let’s now take a look at how we can get our traces from Tempo. In the same Query window next the “Outline”,
select <code>Tempo</code> instead of Prometheus. Then, click on <code>Search</code> next to Query type. You will see a table appear
below with a list of the latest trace IDs and the service they relate to. </p>
<p><img alt="Tempo search" src="../images/tempo-search.png"></p>
<p>Click on any one of the traces to open more details about them. You will see a list of spans that represent different
parts of the request and response, and potentially also the database query, based on which trace you have selected.
Go ahead and explore these traces and spans for a little while to get familiar with the data that’s automatically
tracked when enabling the OpenTelemetry extension. Make sure to also click on the <code>Node Graph</code> to see the flow of the request.</p>
<p>Finally, expand one (or more) of the span elements. You will see details about a particular call in the code,
and you’ll also see a button “Logs for this span”. This allows you to see the logs related to that particular
span. If you don’t see any logs, try another span.</p>
<p><div class="video-container"><video style="position:relative;width:100%;height:22.172vw" controls alt="type:video" autoplay="true"><source src="../images/lc4jLGTM.mp4" type="video/mp4"></source></video></div></p>
<h2 id="fault-tolerance">Fault Tolerance<a class="headerlink" href="#fault-tolerance" title="Permanent link"></a></h2>
<p>Thanks to the introduction of observability in our app we now have good insights into our application
and if something goes wrong, we should (hopefully) be able to pinpoint the issue fairly quickly.</p>
<p>While it’s great that, if there’s an issue, we can now retrieve a lot of details about our application,
the user would still be affected and potentially get an ugly error message.</p>
<p>In this next section, we’re going to add Fault Tolerance to our application’s LLM calls so that,
should something go wrong, we are able to handle it gracefully.</p>
<p>Ultimately, calling an LLM is not much different than making traditional REST calls.
If you’re familiar with Microprofile (https://microprofile.io), you may know that it has a specification
for how to implement Fault Tolerance. Quarkus implements this feature with the <code>quarkus-smallrye-fault-tolerance</code>
extension. Go ahead and add it to the your pom.xml:</p>
<div class="highlight"><span class="filename">pom.xml</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="w">        </span><span class="cm">&lt;!-- Fault Tolerance --&gt;</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>io.quarkus<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>quarkus-smallrye-fault-tolerance<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>
<p>The Microprofile Fault Tolerance spec defines 3 main fault tolerance capabilities:</p>
<ul>
<li>Timeout - allows you to set a maximum time the call to the LLM should take before failing.</li>
<li>Fallback - allows you to call a fallback method in case there’s an error</li>
<li>Retry - allows you to set how many times the call should be retried if there’s an error, 
and what delay there should be in between the calls</li>
</ul>
<p>Now all we have to do is annotate our <code>dev.langchain4j.quarkus.workshop.CustomerSupportAgent</code> AI service with the
following annotations:</p>
<div class="highlight"><span class="filename">CustomerSupportAgentWebSocket.java</span><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">dev.langchain4j.quarkus.workshop</span><span class="p">;</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.SessionScoped</span><span class="p">;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.faulttolerance.ExecutionContext</span><span class="p">;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.faulttolerance.Fallback</span><span class="p">;</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.faulttolerance.FallbackHandler</span><span class="p">;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="hll"><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.faulttolerance.Retry</span><span class="p">;</span>
</span><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.faulttolerance.Timeout</span><span class="p">;</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.service.SystemMessage</span><span class="p">;</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.RegisterAiService</span><span class="p">;</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.ToolBox</span><span class="p">;</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.guardrails.InputGuardrails</span><span class="p">;</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="nd">@SessionScoped</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="nd">@RegisterAiService</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">CustomerSupportAgent</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">    </span><span class="nd">@SystemMessage</span><span class="p">(</span><span class="s">"""</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="s">            You are a customer support agent of a car rental company 'Miles of Smiles'.</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="s">            You are friendly, polite and concise.</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="s">            If the question is unrelated to car rental, you should politely redirect the customer to the right department.</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="s">            Today is {current_date}.</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="s">            """</span><span class="p">)</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">    </span><span class="nd">@InputGuardrails</span><span class="p">(</span><span class="n">PromptInjectionGuard</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">    </span><span class="nd">@ToolBox</span><span class="p">(</span><span class="n">BookingRepository</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="hll"><span class="w">    </span><span class="nd">@Timeout</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
</span><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="hll"><span class="w">    </span><span class="nd">@Retry</span><span class="p">(</span><span class="n">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
</span><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="hll"><span class="w">    </span><span class="nd">@Fallback</span><span class="p">(</span><span class="n">CustomerSupportAgentFallback</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
</span><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">chat</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userMessage</span><span class="p">);</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CustomerSupportAgentFallback</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">FallbackHandler</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">EMPTY_RESPONSE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Failed to get a response from the AI Model. Are you sure it's up and running, and configured correctly?"</span><span class="p">;</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="w">        </span><span class="nd">@Override</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="n">ExecutionContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">EMPTY_RESPONSE</span><span class="p">;</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a><span class="p">}</span>
</code></pre></div>
<p>We also need to add the fallback method to the file:
</p><div class="highlight"><span class="filename">CustomerSupportAgentWebSocket.java</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">dev.langchain4j.quarkus.workshop</span><span class="p">;</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.SessionScoped</span><span class="p">;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.faulttolerance.ExecutionContext</span><span class="p">;</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.faulttolerance.Fallback</span><span class="p">;</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.faulttolerance.FallbackHandler</span><span class="p">;</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="hll"><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.faulttolerance.Retry</span><span class="p">;</span>
</span><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.faulttolerance.Timeout</span><span class="p">;</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.service.SystemMessage</span><span class="p">;</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.RegisterAiService</span><span class="p">;</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.ToolBox</span><span class="p">;</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.guardrails.InputGuardrails</span><span class="p">;</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="nd">@SessionScoped</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="nd">@RegisterAiService</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">CustomerSupportAgent</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">    </span><span class="nd">@SystemMessage</span><span class="p">(</span><span class="s">"""</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="s">            You are a customer support agent of a car rental company 'Miles of Smiles'.</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="s">            You are friendly, polite and concise.</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="s">            If the question is unrelated to car rental, you should politely redirect the customer to the right department.</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="s">            Today is {current_date}.</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="s">            """</span><span class="p">)</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="w">    </span><span class="nd">@InputGuardrails</span><span class="p">(</span><span class="n">PromptInjectionGuard</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="w">    </span><span class="nd">@ToolBox</span><span class="p">(</span><span class="n">BookingRepository</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="w">    </span><span class="nd">@Timeout</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="w">    </span><span class="nd">@Retry</span><span class="p">(</span><span class="n">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="w">    </span><span class="nd">@Fallback</span><span class="p">(</span><span class="n">CustomerSupportAgentFallback</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">chat</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userMessage</span><span class="p">);</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a><span class="hll"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CustomerSupportAgentFallback</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">FallbackHandler</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a><span class="hll">
</span><a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a><span class="hll"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">EMPTY_RESPONSE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Failed to get a response from the AI Model. Are you sure it's up and running, and configured correctly?"</span><span class="p">;</span>
</span><a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a><span class="hll"><span class="w">        </span><span class="nd">@Override</span>
</span><a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a><span class="hll"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="n">ExecutionContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a><span class="hll"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">EMPTY_RESPONSE</span><span class="p">;</span>
</span><a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a><span class="hll">
</span><a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a><span class="p">}</span>
</code></pre></div>
<p>That’s all. To test the implemented fault tolerance, we’ll need to ‘break’ our application.
You can either turn off your wifi, set the @Timeout value to something very low (eg. 10), or
you could set the inference server url to something that won’t resolve, eg:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="na">quarkus.langchain4j.openai.base-url</span><span class="o">=</span><span class="s">https://api.nonsenseurl.com/v1/</span>
</code></pre></div>
<p>It’s up to you to decide what your preferred way to create chaos is :).  Once you’ve done that, run your application and test it with different inputs. You should see that the fallback method is called when the LLM fails to produce a response within the specified timeout. This demonstrates the fault tolerance of our application.</p>
<p><img alt="Fallback is being called when an error occurs" src="../images/fallback.png"></p>
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link"></a></h2>
<p>In this step, we introduced observability to retrieve useful information about the application’s state, performance
and behavior. This is a vital piece for a production-grade application, regardless of whether it’s using AI or not.
We also learned that Quarkus LangChain4j provides relatively straightforward ways to not only add observability
to the application, but also to consult the data produces by it. </p>
<p>We also introduced chaos engineering techniques to simulate failures in our application and observe how our 
fallback mechanism responds. This is a crucial step for ensuring that our application can handle unexpected situations gracefully.</p></div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../step-08/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Step 8 - Guardrails">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Step 8 - Guardrails
              </div>
            </div>
          </a>
        
        
          
          <a href="../step-10/" class="md-footer__link md-footer__link--next" aria-label="Next: Step 10 - Serving the model in pure Java with Jlama">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Step 10 - Serving the model in pure Java with Jlama
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <!--
  Copyright (c) 2016-2022 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Copyright and theme information, adapter to have the Red Hat footer -->
<div class="md-copyright">
    <div class="md-copyright__highlight">
        Sponsored by <a href="https://www.redhat.com"><img style="vertical-align: middle;" alt="Red Hat" src="../images/redhat_reversed.svg"/></a> <br/>
        <a href="https://creativecommons.org/licenses/by/3.0/">CC by 3.0</a> |
        <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </div>
    
    Made with
    <a
            href="https://squidfunk.github.io/mkdocs-material/"
            target="_blank" rel="noopener"
    >
        Material for MkDocs
    </a>
    
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "content.tabs.link", "content.code.annotate", "navigation.instant", "navigation.indexes", "navigation.tracking", "navigation.footer", "navigation.tabs.sticky", "content.code.select", "content.code.copy"], "search": "../assets/javascripts/workers/search.07f07601.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.56dfad97.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>